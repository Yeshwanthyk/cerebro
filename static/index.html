<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guck - Git Diff Reviewer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        .header {
            background-color: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 16px 32px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .repo-info {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #8b949e;
        }

        .repo-info-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px 32px;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .file-card {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            overflow: hidden;
        }

        .file-header {
            padding: 12px 16px;
            background-color: #21262d;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .file-header:hover {
            background-color: #30363d;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-path {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            color: #f0f6fc;
        }

        .file-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .file-status.added {
            background-color: #238636;
            color: #fff;
        }

        .file-status.modified {
            background-color: #9e6a03;
            color: #fff;
        }

        .file-status.deleted {
            background-color: #da3633;
            color: #fff;
        }

        .file-stats {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 12px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .additions {
            color: #3fb950;
        }

        .deletions {
            color: #f85149;
        }

        .viewed-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background-color: #1f6feb;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            color: #fff;
        }

        .view-button {
            padding: 6px 16px;
            background-color: #238636;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .view-button:hover {
            background-color: #2ea043;
        }

        .view-button:disabled {
            background-color: #30363d;
            color: #8b949e;
            cursor: not-allowed;
        }

        .file-diff {
            padding: 0;
            display: none;
        }

        .file-diff.expanded {
            display: block;
        }

        .diff-content {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 12px;
            line-height: 20px;
        }

        .diff-line {
            display: flex;
            padding: 0 16px;
        }

        .diff-line.addition {
            background-color: rgba(63, 185, 80, 0.15);
        }

        .diff-line.deletion {
            background-color: rgba(248, 81, 73, 0.15);
        }

        .diff-line.context {
            background-color: transparent;
        }

        .diff-line-prefix {
            width: 20px;
            flex-shrink: 0;
            color: #8b949e;
            user-select: none;
        }

        .diff-line.addition .diff-line-prefix {
            color: #3fb950;
        }

        .diff-line.deletion .diff-line-prefix {
            color: #f85149;
        }

        .diff-line-content {
            flex: 1;
            white-space: pre;
            overflow-x: auto;
        }

        .loading {
            text-align: center;
            padding: 48px;
            color: #8b949e;
        }

        .error {
            background-color: #da3633;
            color: #fff;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 24px;
        }

        .empty-state {
            text-align: center;
            padding: 48px;
            color: #8b949e;
        }

        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #f0f6fc;
        }

        .summary {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-stats {
            display: flex;
            gap: 24px;
            font-size: 14px;
        }

        .summary-stat strong {
            color: #f0f6fc;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [status, setStatus] = useState(null);
            const [diff, setDiff] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [expandedFiles, setExpandedFiles] = useState(new Set());

            useEffect(() => {
                loadData();
            }, []);

            async function loadData() {
                try {
                    setLoading(true);
                    const [statusRes, diffRes] = await Promise.all([
                        fetch('/api/status'),
                        fetch('/api/diff')
                    ]);

                    if (!statusRes.ok || !diffRes.ok) {
                        throw new Error('Failed to load data');
                    }

                    const statusData = await statusRes.json();
                    const diffData = await diffRes.json();

                    setStatus(statusData);
                    setDiff(diffData);
                    setError(null);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }

            async function markAsViewed(filePath) {
                try {
                    const res = await fetch('/api/mark-viewed', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ file_path: filePath }),
                    });

                    if (!res.ok) {
                        throw new Error('Failed to mark file as viewed');
                    }

                    // Update local state
                    setDiff(prev => ({
                        ...prev,
                        files: prev.files.map(f =>
                            f.path === filePath ? { ...f, viewed: true } : f
                        )
                    }));
                } catch (err) {
                    setError(err.message);
                }
            }

            function toggleFile(filePath) {
                setExpandedFiles(prev => {
                    const next = new Set(prev);
                    if (next.has(filePath)) {
                        next.delete(filePath);
                    } else {
                        next.add(filePath);
                    }
                    return next;
                });
            }

            function renderDiffLine(line, index) {
                const prefix = line[0];
                const content = line.slice(1);
                let lineClass = 'context';

                if (prefix === '+') {
                    lineClass = 'addition';
                } else if (prefix === '-') {
                    lineClass = 'deletion';
                }

                return (
                    <div key={index} className={`diff-line ${lineClass}`}>
                        <span className="diff-line-prefix">{prefix}</span>
                        <span className="diff-line-content">{content}</span>
                    </div>
                );
            }

            if (loading) {
                return <div className="loading">Loading diff...</div>;
            }

            if (error) {
                return (
                    <div className="container">
                        <div className="error">Error: {error}</div>
                    </div>
                );
            }

            const viewedCount = diff?.files.filter(f => f.viewed).length || 0;
            const totalCount = diff?.files.length || 0;

            return (
                <>
                    <header className="header">
                        <div className="header-content">
                            <h1>Guck</h1>
                            <div className="repo-info">
                                <div className="repo-info-item">
                                    <strong>Branch:</strong> {diff?.branch}
                                </div>
                                <div className="repo-info-item">
                                    <strong>Commit:</strong> {diff?.commit.slice(0, 7)}
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="container">
                        {diff && diff.files.length > 0 ? (
                            <>
                                <div className="summary">
                                    <div className="summary-stats">
                                        <div className="summary-stat">
                                            <strong>{totalCount}</strong> file{totalCount !== 1 ? 's' : ''} changed
                                        </div>
                                        <div className="summary-stat">
                                            <strong>{viewedCount}</strong> reviewed
                                        </div>
                                    </div>
                                </div>

                                <div className="file-list">
                                    {diff.files.map(file => (
                                        <div key={file.path} className="file-card">
                                            <div className="file-header" onClick={() => toggleFile(file.path)}>
                                                <div className="file-info">
                                                    <span className="file-path">{file.path}</span>
                                                    <span className={`file-status ${file.status}`}>
                                                        {file.status}
                                                    </span>
                                                    <div className="file-stats">
                                                        <span className="stat additions">
                                                            +{file.additions}
                                                        </span>
                                                        <span className="stat deletions">
                                                            -{file.deletions}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                                                    {file.viewed && (
                                                        <span className="viewed-badge">
                                                            âœ“ Viewed
                                                        </span>
                                                    )}
                                                    <button
                                                        className="view-button"
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            markAsViewed(file.path);
                                                        }}
                                                        disabled={file.viewed}
                                                    >
                                                        {file.viewed ? 'Viewed' : 'Mark as viewed'}
                                                    </button>
                                                </div>
                                            </div>
                                            <div className={`file-diff ${expandedFiles.has(file.path) ? 'expanded' : ''}`}>
                                                <div className="diff-content">
                                                    {file.patch.split('\n').map((line, index) =>
                                                        renderDiffLine(line, index)
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </>
                        ) : (
                            <div className="empty-state">
                                <h2>No changes</h2>
                                <p>There are no differences between your current branch and main.</p>
                            </div>
                        )}
                    </div>
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
