<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Guck</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
        <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <style>
            *, *::before, *::after {
                box-sizing: border-box;
            }

            :root {
                --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                --font-mono: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
                
                /* Light theme (default) */
                --bg-primary: #FAFAF9;
                --bg-secondary: #FFFFFF;
                --bg-tertiary: #F5F5F4;
                --bg-hover: #F0F0EF;
                --bg-code: #FAFAF9;
                
                --text-primary: #1C1C1C;
                --text-secondary: #6B6B6B;
                --text-tertiary: #9A9A9A;
                
                --border-primary: #E8E8E6;
                --border-secondary: #F0F0EE;
                
                --accent: #6B8F71;
                --accent-soft: rgba(107, 143, 113, 0.1);
                
                --addition-bg: rgba(107, 143, 113, 0.08);
                --addition-border: rgba(107, 143, 113, 0.2);
                --addition-text: #4A7050;
                
                --deletion-bg: rgba(194, 117, 108, 0.08);
                --deletion-border: rgba(194, 117, 108, 0.2);
                --deletion-text: #B5635A;
                
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
                --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.05);
                --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.06);
                
                --radius-sm: 6px;
                --radius-md: 10px;
                --radius-lg: 14px;
                
                --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }

            [data-theme="dark"] {
                --bg-primary: #161616;
                --bg-secondary: #1C1C1C;
                --bg-tertiary: #232323;
                --bg-hover: #2A2A2A;
                --bg-code: #1A1A1A;
                
                --text-primary: #E8E8E8;
                --text-secondary: #8C8C8C;
                --text-tertiary: #5C5C5C;
                
                --border-primary: #2A2A2A;
                --border-secondary: #232323;
                
                --accent: #8FB996;
                --accent-soft: rgba(143, 185, 150, 0.12);
                
                --addition-bg: rgba(143, 185, 150, 0.1);
                --addition-border: rgba(143, 185, 150, 0.2);
                --addition-text: #8FB996;
                
                --deletion-bg: rgba(214, 137, 128, 0.1);
                --deletion-border: rgba(214, 137, 128, 0.2);
                --deletion-text: #D68980;
                
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
                --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
                --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
            }

            html {
                font-size: 15px;
            }

            body {
                margin: 0;
                padding: 0;
                font-family: var(--font-sans);
                background-color: var(--bg-primary);
                color: var(--text-primary);
                line-height: 1.6;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                transition: background-color var(--transition), color var(--transition);
            }

            /* Scrollbar styling */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            ::-webkit-scrollbar-thumb {
                background: var(--border-primary);
                border-radius: 4px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: var(--text-tertiary);
            }

            /* Focus styles */
            :focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            button {
                font-family: var(--font-sans);
            }

            /* Animations */
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(8px); }
                to { opacity: 1; transform: translateY(0); }
            }

            @keyframes slideDown {
                from { opacity: 0; max-height: 0; }
                to { opacity: 1; max-height: 2000px; }
            }

            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }

            .fade-in {
                animation: fadeIn 0.4s ease-out forwards;
            }

            .stagger-1 { animation-delay: 0.05s; }
            .stagger-2 { animation-delay: 0.1s; }
            .stagger-3 { animation-delay: 0.15s; }
            .stagger-4 { animation-delay: 0.2s; }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect, useCallback, useRef } = React;

            // ============================================
            // THEME TOGGLE COMPONENT
            // ============================================
            function ThemeToggle({ theme, setTheme }) {
                return (
                    <button
                        onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}
                        aria-label="Toggle theme"
                        style={{
                            background: 'none',
                            border: 'none',
                            padding: '8px',
                            cursor: 'pointer',
                            color: 'var(--text-secondary)',
                            borderRadius: 'var(--radius-sm)',
                            transition: 'all var(--transition)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                        }}
                        onMouseEnter={e => e.target.style.background = 'var(--bg-hover)'}
                        onMouseLeave={e => e.target.style.background = 'none'}
                    >
                        {theme === 'light' ? (
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        ) : (
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/>
                                <line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                        )}
                    </button>
                );
            }

            // ============================================
            // KEYBOARD SHORTCUTS HINT
            // ============================================
            function KeyboardHint({ show }) {
                if (!show) return null;
                
                const shortcuts = [
                    { key: 'j', action: 'Next file' },
                    { key: 'k', action: 'Previous file' },
                    { key: 'o', action: 'Toggle file' },
                    { key: 'n', action: 'Toggle notes' },
                    { key: '?', action: 'Show shortcuts' },
                ];

                return (
                    <div style={{
                        position: 'fixed',
                        bottom: '24px',
                        right: '24px',
                        background: 'var(--bg-secondary)',
                        border: '1px solid var(--border-primary)',
                        borderRadius: 'var(--radius-lg)',
                        padding: '16px 20px',
                        boxShadow: 'var(--shadow-lg)',
                        zIndex: 1000,
                        animation: 'fadeIn 0.2s ease-out',
                    }}>
                        <div style={{ 
                            fontSize: '11px', 
                            fontWeight: 600, 
                            color: 'var(--text-tertiary)',
                            textTransform: 'uppercase',
                            letterSpacing: '0.05em',
                            marginBottom: '12px'
                        }}>
                            Keyboard Shortcuts
                        </div>
                        {shortcuts.map(({ key, action }) => (
                            <div key={key} style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '12px',
                                marginBottom: '8px',
                                fontSize: '13px',
                            }}>
                                <kbd style={{
                                    background: 'var(--bg-tertiary)',
                                    border: '1px solid var(--border-primary)',
                                    borderRadius: '4px',
                                    padding: '2px 8px',
                                    fontFamily: 'var(--font-mono)',
                                    fontSize: '12px',
                                    fontWeight: 500,
                                    minWidth: '24px',
                                    textAlign: 'center',
                                }}>
                                    {key}
                                </kbd>
                                <span style={{ color: 'var(--text-secondary)' }}>{action}</span>
                            </div>
                        ))}
                    </div>
                );
            }

            // ============================================
            // SIMPLE MARKDOWN RENDERER
            // ============================================
            function renderMarkdown(text) {
                if (!text) return null;
                
                // Split into paragraphs
                const paragraphs = text.split(/\n\n+/);
                
                return paragraphs.map((para, i) => {
                    // Process inline formatting
                    let processed = para
                        // Bold: **text** or __text__
                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                        .replace(/__([^_]+)__/g, '<strong>$1</strong>')
                        // Italic: *text* or _text_
                        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                        .replace(/_([^_]+)_/g, '<em>$1</em>')
                        // Code: `text`
                        .replace(/`([^`]+)`/g, '<code style="background:var(--bg-tertiary);padding:1px 4px;border-radius:3px;font-size:12px;font-family:var(--font-mono)">$1</code>')
                        // Line breaks within paragraph
                        .replace(/\n/g, '<br/>');
                    
                    return (
                        <p 
                            key={i} 
                            style={{ margin: i === 0 ? 0 : '8px 0 0 0' }}
                            dangerouslySetInnerHTML={{ __html: processed }}
                        />
                    );
                });
            }

            // ============================================
            // INLINE NOTE COMPONENT
            // ============================================
            function InlineNote({ note, onDismiss }) {
                const [expanded, setExpanded] = useState(false);
                
                const typeColors = {
                    'RATIONALE': 'var(--accent)',
                    'EXPLANATION': '#9382BA',
                    'WARNING': '#D6A36C',
                    'TODO': '#6CA3D6',
                };
                
                const accentColor = typeColors[note.type?.toUpperCase()] || typeColors['RATIONALE'];
                const previewLength = 150;
                const needsExpansion = note.text.length > previewLength;
                const displayText = expanded ? note.text : note.text.slice(0, previewLength) + (needsExpansion ? '...' : '');

                return (
                    <div style={{
                        margin: '4px 0 4px 72px',
                        padding: '10px 14px',
                        background: 'var(--bg-secondary)',
                        borderLeft: `2px solid ${accentColor}`,
                        borderRadius: '0 var(--radius-sm) var(--radius-sm) 0',
                        animation: 'fadeIn 0.2s ease-out',
                    }}>
                        <div style={{ 
                            display: 'flex', 
                            alignItems: 'flex-start', 
                            justifyContent: 'space-between',
                            gap: '12px',
                        }}>
                            <div style={{ flex: 1, minWidth: 0 }}>
                                <div style={{ 
                                    display: 'flex', 
                                    alignItems: 'center', 
                                    gap: '6px', 
                                    marginBottom: '6px' 
                                }}>
                                    <span style={{
                                        fontSize: '10px',
                                        fontWeight: 600,
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.03em',
                                        color: accentColor,
                                    }}>
                                        {note.author}
                                    </span>
                                    <span style={{
                                        fontSize: '10px',
                                        color: 'var(--text-tertiary)',
                                    }}>
                                        ·
                                    </span>
                                    <span style={{
                                        fontSize: '10px',
                                        color: 'var(--text-tertiary)',
                                        textTransform: 'lowercase',
                                    }}>
                                        {note.type}
                                    </span>
                                </div>
                                <div style={{
                                    fontSize: '13px',
                                    lineHeight: 1.5,
                                    color: 'var(--text-secondary)',
                                }}>
                                    {renderMarkdown(displayText)}
                                </div>
                                {needsExpansion && (
                                    <button
                                        onClick={() => setExpanded(!expanded)}
                                        style={{
                                            background: 'none',
                                            border: 'none',
                                            color: 'var(--text-tertiary)',
                                            fontSize: '11px',
                                            cursor: 'pointer',
                                            padding: 0,
                                            marginTop: '6px',
                                        }}
                                    >
                                        {expanded ? '↑ less' : '↓ more'}
                                    </button>
                                )}
                            </div>
                            <button
                                onClick={() => onDismiss(note.id)}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    color: 'var(--text-tertiary)',
                                    cursor: 'pointer',
                                    padding: '2px 6px',
                                    borderRadius: 'var(--radius-sm)',
                                    fontSize: '11px',
                                    opacity: 0.5,
                                    transition: 'opacity var(--transition)',
                                }}
                                onMouseEnter={e => e.target.style.opacity = 1}
                                onMouseLeave={e => e.target.style.opacity = 0.5}
                            >
                                dismiss
                            </button>
                        </div>
                    </div>
                );
            }

            // ============================================
            // DIFF LINE COMPONENT
            // ============================================
            function DiffLine({ line, lineNumber, onAddComment }) {
                const [hovered, setHovered] = useState(false);
                const prefix = line[0] || ' ';
                const content = line.slice(1);
                
                let bgColor = 'transparent';
                let borderColor = 'transparent';
                let prefixColor = 'var(--text-tertiary)';
                
                if (prefix === '+') {
                    bgColor = 'var(--addition-bg)';
                    borderColor = 'var(--addition-border)';
                    prefixColor = 'var(--addition-text)';
                } else if (prefix === '-') {
                    bgColor = 'var(--deletion-bg)';
                    borderColor = 'var(--deletion-border)';
                    prefixColor = 'var(--deletion-text)';
                }

                return (
                    <div
                        onMouseEnter={() => setHovered(true)}
                        onMouseLeave={() => setHovered(false)}
                        style={{
                            display: 'flex',
                            alignItems: 'stretch',
                            background: bgColor,
                            borderLeft: `2px solid ${borderColor}`,
                            transition: 'background var(--transition)',
                            position: 'relative',
                        }}
                    >
                        {/* Add comment button */}
                        <button
                            onClick={() => onAddComment(lineNumber)}
                            style={{
                                position: 'absolute',
                                left: '8px',
                                top: '50%',
                                transform: 'translateY(-50%)',
                                width: '20px',
                                height: '20px',
                                borderRadius: '50%',
                                border: 'none',
                                background: 'var(--accent)',
                                color: 'white',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: 500,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                opacity: hovered ? 1 : 0,
                                transition: 'opacity var(--transition), transform var(--transition)',
                                boxShadow: 'var(--shadow-sm)',
                            }}
                            onMouseEnter={e => e.target.style.transform = 'translateY(-50%) scale(1.1)'}
                            onMouseLeave={e => e.target.style.transform = 'translateY(-50%) scale(1)'}
                        >
                            +
                        </button>

                        {/* Line number */}
                        <span style={{
                            width: '52px',
                            padding: '0 12px',
                            textAlign: 'right',
                            color: 'var(--text-tertiary)',
                            fontSize: '12px',
                            fontFamily: 'var(--font-mono)',
                            userSelect: 'none',
                            flexShrink: 0,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'flex-end',
                        }}>
                            {lineNumber}
                        </span>

                        {/* Prefix */}
                        <span style={{
                            width: '20px',
                            textAlign: 'center',
                            color: prefixColor,
                            fontFamily: 'var(--font-mono)',
                            fontSize: '13px',
                            fontWeight: 500,
                            userSelect: 'none',
                            flexShrink: 0,
                        }}>
                            {prefix !== ' ' ? prefix : ''}
                        </span>

                        {/* Content */}
                        <span style={{
                            flex: 1,
                            padding: '2px 16px 2px 4px',
                            fontFamily: 'var(--font-mono)',
                            fontSize: '13px',
                            lineHeight: '22px',
                            whiteSpace: 'pre',
                            overflowX: 'auto',
                        }}>
                            {content}
                        </span>
                    </div>
                );
            }

            // ============================================
            // COMMENT FORM COMPONENT
            // ============================================
            function CommentForm({ lineNumber, lineContent, onSubmit, onCancel }) {
                const [text, setText] = useState('');
                const textareaRef = useRef(null);

                useEffect(() => {
                    textareaRef.current?.focus();
                }, []);

                const handleSubmit = () => {
                    if (text.trim()) {
                        onSubmit(text.trim());
                        setText('');
                    }
                };

                const handleKeyDown = (e) => {
                    if (e.key === 'Enter' && e.metaKey) {
                        handleSubmit();
                    } else if (e.key === 'Escape') {
                        onCancel();
                    }
                };

                return (
                    <div style={{
                        margin: '8px 0 8px 52px',
                        padding: '16px',
                        background: 'var(--bg-secondary)',
                        border: '1px solid var(--border-primary)',
                        borderRadius: 'var(--radius-md)',
                        animation: 'fadeIn 0.2s ease-out',
                    }}>
                        <div style={{
                            fontSize: '12px',
                            color: 'var(--text-secondary)',
                            marginBottom: '8px',
                        }}>
                            Comment on line {lineNumber}
                        </div>
                        {lineContent && (
                            <div style={{
                                fontSize: '11px',
                                fontFamily: 'var(--font-mono)',
                                color: 'var(--text-tertiary)',
                                background: 'var(--bg-tertiary)',
                                padding: '6px 10px',
                                borderRadius: 'var(--radius-sm)',
                                marginBottom: '12px',
                                whiteSpace: 'nowrap',
                                overflow: 'hidden',
                                textOverflow: 'ellipsis',
                            }}>
                                {lineContent}
                            </div>
                        )}
                        <textarea
                            ref={textareaRef}
                            value={text}
                            onChange={e => setText(e.target.value)}
                            onKeyDown={handleKeyDown}
                            placeholder="Write your comment..."
                            rows={3}
                            style={{
                                width: '100%',
                                padding: '12px',
                                border: '1px solid var(--border-primary)',
                                borderRadius: 'var(--radius-sm)',
                                background: 'var(--bg-primary)',
                                color: 'var(--text-primary)',
                                fontFamily: 'var(--font-sans)',
                                fontSize: '14px',
                                lineHeight: 1.6,
                                resize: 'vertical',
                                minHeight: '80px',
                                transition: 'border-color var(--transition)',
                            }}
                        />
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginTop: '12px',
                        }}>
                            <span style={{
                                fontSize: '11px',
                                color: 'var(--text-tertiary)',
                            }}>
                                ⌘ + Enter to submit
                            </span>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button
                                    onClick={onCancel}
                                    style={{
                                        padding: '8px 16px',
                                        border: '1px solid var(--border-primary)',
                                        borderRadius: 'var(--radius-sm)',
                                        background: 'transparent',
                                        color: 'var(--text-secondary)',
                                        fontSize: '13px',
                                        fontWeight: 500,
                                        cursor: 'pointer',
                                        transition: 'all var(--transition)',
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleSubmit}
                                    disabled={!text.trim()}
                                    style={{
                                        padding: '8px 16px',
                                        border: 'none',
                                        borderRadius: 'var(--radius-sm)',
                                        background: text.trim() ? 'var(--accent)' : 'var(--bg-tertiary)',
                                        color: text.trim() ? 'white' : 'var(--text-tertiary)',
                                        fontSize: '13px',
                                        fontWeight: 500,
                                        cursor: text.trim() ? 'pointer' : 'not-allowed',
                                        transition: 'all var(--transition)',
                                    }}
                                >
                                    Comment
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // ============================================
            // COMMENT DISPLAY COMPONENT
            // ============================================
            function Comment({ comment, onResolve }) {
                // Strip context prefix for display (but it's still in the data for agents)
                const displayText = comment.text.replace(/^\[context: `[^`]*`\]\n?/, '');
                const contextMatch = comment.text.match(/^\[context: `([^`]*)`\]/);
                const context = contextMatch ? contextMatch[1] : null;
                
                return (
                    <div style={{
                        margin: '8px 0 8px 52px',
                        padding: '14px 16px',
                        background: 'var(--bg-tertiary)',
                        borderRadius: 'var(--radius-sm)',
                        animation: 'fadeIn 0.3s ease-out',
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'flex-start',
                            gap: '12px',
                        }}>
                            <div style={{ flex: 1 }}>
                                {context && (
                                    <div style={{
                                        fontSize: '11px',
                                        fontFamily: 'var(--font-mono)',
                                        color: 'var(--text-tertiary)',
                                        marginBottom: '8px',
                                        whiteSpace: 'nowrap',
                                        overflow: 'hidden',
                                        textOverflow: 'ellipsis',
                                    }}>
                                        {context}
                                    </div>
                                )}
                                <div style={{
                                    fontSize: '13px',
                                    lineHeight: 1.6,
                                    color: 'var(--text-primary)',
                                }}>
                                    {displayText}
                                </div>
                                <div style={{
                                    fontSize: '11px',
                                    color: 'var(--text-tertiary)',
                                    marginTop: '8px',
                                }}>
                                    {new Date(comment.timestamp * 1000).toLocaleString()}
                                </div>
                            </div>
                            <button
                                onClick={() => onResolve(comment.id)}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    color: 'var(--accent)',
                                    fontSize: '12px',
                                    fontWeight: 500,
                                    cursor: 'pointer',
                                    padding: '4px 8px',
                                    borderRadius: 'var(--radius-sm)',
                                    transition: 'background var(--transition)',
                                }}
                                onMouseEnter={e => e.target.style.background = 'var(--accent-soft)'}
                                onMouseLeave={e => e.target.style.background = 'none'}
                            >
                                Resolve
                            </button>
                        </div>
                    </div>
                );
            }

            // ============================================
            // FILE CARD COMPONENT
            // ============================================
            function FileCard({ 
                file, 
                isExpanded, 
                isFocused,
                onToggle, 
                onToggleViewed,
                comments,
                notes,
                showNotes,
                onAddComment,
                onResolveComment,
                onDismissNote,
            }) {
                const [activeCommentLine, setActiveCommentLine] = useState(null);
                
                const statusStyles = {
                    added: { label: 'New', color: 'var(--addition-text)', bg: 'var(--addition-bg)' },
                    modified: { label: 'Modified', color: '#D6A36C', bg: 'rgba(214, 163, 108, 0.1)' },
                    deleted: { label: 'Deleted', color: 'var(--deletion-text)', bg: 'var(--deletion-bg)' },
                    renamed: { label: 'Renamed', color: '#6CA3D6', bg: 'rgba(108, 163, 214, 0.1)' },
                    untracked: { label: 'Untracked', color: 'var(--text-secondary)', bg: 'var(--bg-tertiary)' },
                };
                
                const status = statusStyles[file.status] || statusStyles.modified;

                // Parse patch and render lines with notes
                const renderDiff = () => {
                    if (!file.patch) return null;
                    
                    const lines = file.patch.split('\n');
                    let currentLineNumber = 0; // Absolute line number in new file
                    const elements = [];

                    lines.forEach((line, index) => {
                        // Skip diff header lines
                        if (line.startsWith('diff --git') ||
                            line.startsWith('index ') ||
                            line.startsWith('--- ') ||
                            line.startsWith('+++ ') ||
                            line.startsWith('new file') ||
                            line.startsWith('deleted file') ||
                            line.startsWith('similarity') ||
                            line.startsWith('rename ')) {
                            return;
                        }
                        
                        // Parse hunk header: @@ -oldStart,oldCount +newStart,newCount @@
                        if (line.startsWith('@@')) {
                            const match = line.match(/@@ -\d+(?:,\d+)? \+(\d+)(?:,\d+)? @@/);
                            if (match) {
                                currentLineNumber = parseInt(match[1], 10) - 1;
                            }
                            return; // Skip rendering hunk headers
                        }
                        
                        const prefix = line[0];
                        if (prefix === '+' || prefix === ' ') {
                            currentLineNumber++;
                        }
                        
                        const lineNum = currentLineNumber;
                        
                        const lineContent = line.slice(1).trim(); // Remove prefix (+/-/ ) and trim
                        
                        // Render the diff line
                        elements.push(
                            <DiffLine
                                key={`line-${index}`}
                                line={line}
                                lineNumber={lineNum}
                                onAddComment={(ln) => setActiveCommentLine({ lineNum: ln, content: lineContent })}
                            />
                        );

                        // Render comments for this line
                        const lineComments = (comments || []).filter(
                            c => c.line_number === lineNum && !c.resolved
                        );
                        lineComments.forEach(comment => {
                            elements.push(
                                <Comment
                                    key={`comment-${comment.id}`}
                                    comment={comment}
                                    onResolve={onResolveComment}
                                />
                            );
                        });

                        // Render notes for this line (if showing notes)
                        if (showNotes) {
                            const lineNotes = (notes || []).filter(
                                n => n.line_number === lineNum && !n.dismissed
                            );
                            lineNotes.forEach(note => {
                                elements.push(
                                    <InlineNote
                                        key={`note-${note.id}`}
                                        note={note}
                                        onDismiss={onDismissNote}
                                    />
                                );
                            });
                        }

                        // Render comment form if active
                        if (activeCommentLine?.lineNum === lineNum) {
                            elements.push(
                                <CommentForm
                                    key={`form-${lineNum}`}
                                    lineNumber={lineNum}
                                    lineContent={activeCommentLine.content}
                                    onSubmit={(text) => {
                                        onAddComment(file.path, lineNum, text, activeCommentLine.content);
                                        setActiveCommentLine(null);
                                    }}
                                    onCancel={() => setActiveCommentLine(null)}
                                />
                            );
                        }
                    });

                    return elements;
                };

                const noteCount = (notes || []).filter(n => !n.dismissed).length;
                const commentCount = (comments || []).filter(c => !c.resolved).length;

                return (
                    <div
                        className="fade-in"
                        style={{
                            background: 'var(--bg-secondary)',
                            border: `1px solid ${isFocused ? 'var(--accent)' : 'var(--border-primary)'}`,
                            borderRadius: 'var(--radius-lg)',
                            overflow: 'hidden',
                            boxShadow: isFocused ? '0 0 0 3px var(--accent-soft)' : 'var(--shadow-sm)',
                            transition: 'all var(--transition)',
                        }}
                    >
                        {/* Header */}
                        <div
                            onClick={onToggle}
                            style={{
                                padding: '16px 20px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                transition: 'background var(--transition)',
                                borderBottom: isExpanded ? '1px solid var(--border-secondary)' : 'none',
                            }}
                            onMouseEnter={e => e.currentTarget.style.background = 'var(--bg-hover)'}
                            onMouseLeave={e => e.currentTarget.style.background = 'transparent'}
                        >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flex: 1, minWidth: 0 }}>
                                {/* Expand indicator */}
                                <svg
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="var(--text-tertiary)"
                                    strokeWidth="2"
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    style={{
                                        transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)',
                                        transition: 'transform var(--transition)',
                                        flexShrink: 0,
                                    }}
                                >
                                    <polyline points="9 18 15 12 9 6"/>
                                </svg>

                                {/* File path */}
                                <span style={{
                                    fontFamily: 'var(--font-mono)',
                                    fontSize: '13px',
                                    fontWeight: 500,
                                    color: 'var(--text-primary)',
                                    whiteSpace: 'nowrap',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                }}>
                                    {file.path}
                                </span>

                                {/* Status badge */}
                                <span style={{
                                    fontSize: '10px',
                                    fontWeight: 600,
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.05em',
                                    color: status.color,
                                    background: status.bg,
                                    padding: '3px 8px',
                                    borderRadius: '4px',
                                    flexShrink: 0,
                                }}>
                                    {status.label}
                                </span>

                                {/* Stats */}
                                <div style={{ 
                                    display: 'flex', 
                                    gap: '8px', 
                                    fontSize: '12px',
                                    fontFamily: 'var(--font-mono)',
                                    flexShrink: 0,
                                }}>
                                    <span style={{ color: 'var(--addition-text)' }}>+{file.additions}</span>
                                    <span style={{ color: 'var(--deletion-text)' }}>−{file.deletions}</span>
                                </div>

                                {/* Note/comment counts */}
                                {(noteCount > 0 || commentCount > 0) && (
                                    <div style={{ display: 'flex', gap: '8px', flexShrink: 0 }}>
                                        {noteCount > 0 && (
                                            <span style={{
                                                fontSize: '11px',
                                                color: 'var(--accent)',
                                                background: 'var(--accent-soft)',
                                                padding: '2px 6px',
                                                borderRadius: '4px',
                                            }}>
                                                {noteCount} note{noteCount !== 1 ? 's' : ''}
                                            </span>
                                        )}
                                        {commentCount > 0 && (
                                            <span style={{
                                                fontSize: '11px',
                                                color: 'var(--text-secondary)',
                                                background: 'var(--bg-tertiary)',
                                                padding: '2px 6px',
                                                borderRadius: '4px',
                                            }}>
                                                {commentCount} comment{commentCount !== 1 ? 's' : ''}
                                            </span>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Viewed checkbox */}
                            <label
                                onClick={e => e.stopPropagation()}
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    cursor: 'pointer',
                                    marginLeft: '16px',
                                    flexShrink: 0,
                                }}
                            >
                                <input
                                    type="checkbox"
                                    checked={file.viewed}
                                    onChange={() => onToggleViewed(file.path, file.viewed)}
                                    style={{
                                        width: '16px',
                                        height: '16px',
                                        accentColor: 'var(--accent)',
                                        cursor: 'pointer',
                                    }}
                                />
                                <span style={{
                                    fontSize: '12px',
                                    color: file.viewed ? 'var(--accent)' : 'var(--text-tertiary)',
                                    fontWeight: file.viewed ? 500 : 400,
                                }}>
                                    Reviewed
                                </span>
                            </label>
                        </div>

                        {/* Diff content */}
                        {isExpanded && (
                            <div style={{
                                background: 'var(--bg-code)',
                                overflowX: 'auto',
                                padding: '8px 0',
                            }}>
                                {renderDiff()}
                            </div>
                        )}
                    </div>
                );
            }

            // ============================================
            // MODE SWITCHER COMPONENT
            // ============================================
            function ModeSwitcher({ currentMode, onModeChange }) {
                const modes = [
                    { id: 'branch', label: 'Branch', description: 'Changes from base branch' },
                    { id: 'working', label: 'Working', description: 'Unstaged changes' },
                    { id: 'staged', label: 'Staged', description: 'Staged for commit' },
                ];

                return (
                    <div style={{
                        display: 'flex',
                        background: 'var(--bg-tertiary)',
                        borderRadius: 'var(--radius-sm)',
                        padding: '3px',
                        gap: '2px',
                    }}>
                        {modes.map(mode => (
                            <button
                                key={mode.id}
                                onClick={() => onModeChange(mode.id)}
                                title={mode.description}
                                style={{
                                    padding: '6px 12px',
                                    border: 'none',
                                    borderRadius: '4px',
                                    background: currentMode === mode.id ? 'var(--bg-secondary)' : 'transparent',
                                    color: currentMode === mode.id ? 'var(--text-primary)' : 'var(--text-tertiary)',
                                    fontSize: '12px',
                                    fontWeight: 500,
                                    cursor: 'pointer',
                                    transition: 'all var(--transition)',
                                    boxShadow: currentMode === mode.id ? 'var(--shadow-sm)' : 'none',
                                }}
                            >
                                {mode.label}
                            </button>
                        ))}
                    </div>
                );
            }

            // ============================================
            // MAIN APP COMPONENT
            // ============================================
            function App() {
                const [theme, setTheme] = useState(() => {
                    return localStorage.getItem('guck-theme') || 'dark';
                });
                const [status, setStatus] = useState(null);
                const [diff, setDiff] = useState(null);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);
                const [expandedFiles, setExpandedFiles] = useState(new Set());
                const [focusedIndex, setFocusedIndex] = useState(0);
                const [comments, setComments] = useState({});
                const [notes, setNotes] = useState({});
                const [showNotes, setShowNotes] = useState(true);
                const [showKeyboardHint, setShowKeyboardHint] = useState(false);
                const [mode, setMode] = useState('branch');

                // Apply theme
                useEffect(() => {
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('guck-theme', theme);
                }, [theme]);

                // Load data
                useEffect(() => {
                    loadData(mode);
                }, [mode]);

                // Keyboard shortcuts
                useEffect(() => {
                    const handleKeyDown = (e) => {
                        // Ignore if typing in an input
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                        
                        const files = diff?.files || [];
                        
                        switch (e.key) {
                            case 'j':
                                setFocusedIndex(i => Math.min(i + 1, files.length - 1));
                                break;
                            case 'k':
                                setFocusedIndex(i => Math.max(i - 1, 0));
                                break;
                            case 'o':
                                if (files[focusedIndex]) {
                                    toggleFile(files[focusedIndex].path);
                                }
                                break;
                            case 'n':
                                setShowNotes(s => !s);
                                break;
                            case '?':
                                setShowKeyboardHint(s => !s);
                                break;
                            case 'Escape':
                                setShowKeyboardHint(false);
                                break;
                        }
                    };

                    window.addEventListener('keydown', handleKeyDown);
                    return () => window.removeEventListener('keydown', handleKeyDown);
                }, [diff, focusedIndex]);

                async function loadData(currentMode) {
                    try {
                        setLoading(true);
                        const modeParam = currentMode ? `?mode=${currentMode}` : '';
                        const [statusRes, diffRes, commentsRes, notesRes] = await Promise.all([
                            fetch('/api/status'),
                            fetch(`/api/diff${modeParam}`),
                            fetch('/api/comments'),
                            fetch('/api/notes').catch(() => ({ ok: false })),
                        ]);

                        if (!statusRes.ok || !diffRes.ok) {
                            throw new Error('Failed to load data');
                        }

                        const statusData = await statusRes.json();
                        const diffData = await diffRes.json();
                        
                        let commentsData = [];
                        if (commentsRes.ok) {
                            commentsData = await commentsRes.json();
                        }

                        let notesData = [];
                        if (notesRes.ok) {
                            notesData = await notesRes.json();
                        }

                        setStatus(statusData);
                        setDiff(diffData);
                        
                        // Update mode from server response if available
                        if (diffData.mode) {
                            setMode(diffData.mode);
                        }

                        // Group comments by file
                        const commentsByFile = {};
                        commentsData.forEach(c => {
                            if (!commentsByFile[c.file_path]) commentsByFile[c.file_path] = [];
                            commentsByFile[c.file_path].push(c);
                        });
                        setComments(commentsByFile);

                        // Group notes by file
                        const notesByFile = {};
                        notesData.forEach(n => {
                            if (!notesByFile[n.file_path]) notesByFile[n.file_path] = [];
                            notesByFile[n.file_path].push(n);
                        });
                        setNotes(notesByFile);

                        setError(null);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                }

                function toggleFile(filePath) {
                    setExpandedFiles(prev => {
                        const next = new Set(prev);
                        if (next.has(filePath)) {
                            next.delete(filePath);
                        } else {
                            next.add(filePath);
                        }
                        return next;
                    });
                }

                async function toggleViewed(filePath, currentlyViewed) {
                    try {
                        const endpoint = currentlyViewed ? '/api/unmark-viewed' : '/api/mark-viewed';
                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_path: filePath }),
                        });

                        if (!res.ok) throw new Error('Failed to update');

                        setDiff(prev => ({
                            ...prev,
                            files: prev.files.map(f =>
                                f.path === filePath ? { ...f, viewed: !currentlyViewed } : f
                            ),
                        }));

                        if (!currentlyViewed) {
                            setExpandedFiles(prev => {
                                const next = new Set(prev);
                                next.delete(filePath);
                                return next;
                            });
                        }
                    } catch (err) {
                        setError(err.message);
                    }
                }

                async function addComment(filePath, lineNumber, text, lineContent) {
                    try {
                        // Include line content as context for agents
                        const commentText = lineContent 
                            ? `[context: \`${lineContent}\`]\n${text}`
                            : text;
                        
                        const res = await fetch('/api/comments', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                file_path: filePath,
                                line_number: lineNumber,
                                text: commentText,
                            }),
                        });

                        if (!res.ok) throw new Error('Failed to add comment');

                        const newComment = await res.json();
                        setComments(prev => ({
                            ...prev,
                            [filePath]: [...(prev[filePath] || []), newComment],
                        }));
                    } catch (err) {
                        setError(err.message);
                    }
                }

                async function resolveComment(commentId) {
                    try {
                        const res = await fetch('/api/comments/resolve', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ comment_id: commentId }),
                        });

                        if (!res.ok) throw new Error('Failed to resolve comment');

                        setComments(prev => {
                            const updated = {};
                            for (const [path, fileComments] of Object.entries(prev)) {
                                updated[path] = fileComments.map(c =>
                                    c.id === commentId ? { ...c, resolved: true } : c
                                );
                            }
                            return updated;
                        });
                    } catch (err) {
                        setError(err.message);
                    }
                }

                async function dismissNote(noteId) {
                    try {
                        await fetch('/api/notes/dismiss', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ note_id: noteId }),
                        });

                        setNotes(prev => {
                            const updated = {};
                            for (const [path, fileNotes] of Object.entries(prev)) {
                                updated[path] = fileNotes.map(n =>
                                    n.id === noteId ? { ...n, dismissed: true } : n
                                );
                            }
                            return updated;
                        });
                    } catch (err) {
                        // Silently fail for dismiss
                    }
                }

                const viewedCount = diff?.files.filter(f => f.viewed).length || 0;
                const totalCount = diff?.files.length || 0;
                const totalNotes = Object.values(notes).flat().filter(n => !n.dismissed).length;

                if (loading) {
                    return (
                        <div style={{
                            minHeight: '100vh',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                        }}>
                            <div style={{
                                textAlign: 'center',
                                animation: 'pulse 2s ease-in-out infinite',
                            }}>
                                <div style={{
                                    fontSize: '24px',
                                    fontWeight: 600,
                                    color: 'var(--text-primary)',
                                    marginBottom: '8px',
                                }}>
                                    Guck
                                </div>
                                <div style={{
                                    fontSize: '14px',
                                    color: 'var(--text-tertiary)',
                                }}>
                                    Loading diff...
                                </div>
                            </div>
                        </div>
                    );
                }

                if (error) {
                    return (
                        <div style={{
                            minHeight: '100vh',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            padding: '24px',
                        }}>
                            <div style={{
                                background: 'var(--deletion-bg)',
                                border: '1px solid var(--deletion-border)',
                                borderRadius: 'var(--radius-lg)',
                                padding: '24px 32px',
                                maxWidth: '400px',
                                textAlign: 'center',
                            }}>
                                <div style={{
                                    color: 'var(--deletion-text)',
                                    fontWeight: 600,
                                    marginBottom: '8px',
                                }}>
                                    Error
                                </div>
                                <div style={{ color: 'var(--text-secondary)' }}>
                                    {error}
                                </div>
                            </div>
                        </div>
                    );
                }

                return (
                    <div style={{
                        minHeight: '100vh',
                        padding: '32px 24px 64px',
                        maxWidth: '1200px',
                        margin: '0 auto',
                    }}>
                        {/* Header */}
                        <header style={{
                            display: 'flex',
                            alignItems: 'flex-start',
                            justifyContent: 'space-between',
                            marginBottom: '48px',
                        }}>
                            <div>
                                <h1 style={{
                                    fontSize: '28px',
                                    fontWeight: 600,
                                    color: 'var(--text-primary)',
                                    margin: 0,
                                    letterSpacing: '-0.02em',
                                }}>
                                    Guck
                                </h1>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '16px',
                                    marginTop: '8px',
                                }}>
                                    <span style={{
                                        fontSize: '13px',
                                        color: 'var(--text-secondary)',
                                        fontFamily: 'var(--font-mono)',
                                    }}>
                                        {diff?.branch}
                                    </span>
                                    <span style={{
                                        fontSize: '12px',
                                        color: 'var(--text-tertiary)',
                                        fontFamily: 'var(--font-mono)',
                                    }}>
                                        {diff?.commit?.slice(0, 7)}
                                    </span>
                                </div>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                {/* Mode switcher */}
                                <ModeSwitcher 
                                    currentMode={mode} 
                                    onModeChange={(newMode) => {
                                        setMode(newMode);
                                        setExpandedFiles(new Set());
                                        setFocusedIndex(0);
                                    }} 
                                />
                                
                                {/* Notes toggle */}
                                <button
                                    onClick={() => setShowNotes(!showNotes)}
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        padding: '8px 12px',
                                        border: '1px solid var(--border-primary)',
                                        borderRadius: 'var(--radius-sm)',
                                        background: showNotes ? 'var(--accent-soft)' : 'transparent',
                                        color: showNotes ? 'var(--accent)' : 'var(--text-secondary)',
                                        fontSize: '12px',
                                        fontWeight: 500,
                                        cursor: 'pointer',
                                        transition: 'all var(--transition)',
                                    }}
                                >
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                    </svg>
                                    Notes {totalNotes > 0 && `(${totalNotes})`}
                                </button>
                                <ThemeToggle theme={theme} setTheme={setTheme} />
                            </div>
                        </header>

                        {/* Progress bar */}
                        {totalCount > 0 && (
                            <div className="fade-in" style={{ marginBottom: '32px' }}>
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    marginBottom: '12px',
                                }}>
                                    <span style={{
                                        fontSize: '14px',
                                        color: 'var(--text-secondary)',
                                    }}>
                                        <strong style={{ color: 'var(--text-primary)' }}>{viewedCount}</strong> of {totalCount} files reviewed
                                    </span>
                                    <span style={{
                                        fontSize: '12px',
                                        color: 'var(--text-tertiary)',
                                    }}>
                                        Press <kbd style={{
                                            background: 'var(--bg-tertiary)',
                                            padding: '2px 6px',
                                            borderRadius: '3px',
                                            fontFamily: 'var(--font-mono)',
                                            fontSize: '11px',
                                        }}>?</kbd> for shortcuts
                                    </span>
                                </div>
                                <div style={{
                                    height: '4px',
                                    background: 'var(--bg-tertiary)',
                                    borderRadius: '2px',
                                    overflow: 'hidden',
                                }}>
                                    <div style={{
                                        height: '100%',
                                        width: `${(viewedCount / totalCount) * 100}%`,
                                        background: 'var(--accent)',
                                        borderRadius: '2px',
                                        transition: 'width 0.4s ease-out',
                                    }} />
                                </div>
                            </div>
                        )}

                        {/* File list */}
                        {diff && diff.files.length > 0 ? (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                {diff.files.map((file, index) => (
                                    <FileCard
                                        key={file.path}
                                        file={file}
                                        isExpanded={expandedFiles.has(file.path)}
                                        isFocused={index === focusedIndex}
                                        onToggle={() => {
                                            toggleFile(file.path);
                                            setFocusedIndex(index);
                                        }}
                                        onToggleViewed={toggleViewed}
                                        comments={comments[file.path]}
                                        notes={notes[file.path]}
                                        showNotes={showNotes}
                                        onAddComment={addComment}
                                        onResolveComment={resolveComment}
                                        onDismissNote={dismissNote}
                                    />
                                ))}
                            </div>
                        ) : (
                            <div className="fade-in" style={{
                                textAlign: 'center',
                                padding: '80px 24px',
                            }}>
                                <div style={{
                                    fontSize: '16px',
                                    fontWeight: 500,
                                    color: 'var(--text-secondary)',
                                    marginBottom: '6px',
                                }}>
                                    No changes
                                </div>
                                <div style={{
                                    fontSize: '13px',
                                    color: 'var(--text-tertiary)',
                                }}>
                                    Your branch is up to date with the base branch
                                </div>
                            </div>
                        )}

                        {/* Keyboard hints */}
                        <KeyboardHint show={showKeyboardHint} />
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        </script>
    </body>
</html>
